<!DOCTYPE html>
<html>

<head>
    <script type="text/javascript" src="/homey.js" data-origin="settings"></script>

    <style type="text/css">
      .form-wrapper {
        width: 100%;
        height: 100%;

        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
      }

      .alert {
        position: relative;
        padding: 0.75rem 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid transparent;
        border-radius: 0.25rem;
      }

      .hint {
        color: #004085;
        background-color: #cce5ff;
        border-color: #b8daff;
      }

      .help {
        color: #383d41;
        background-color: #f4f5f5;
        border-color: #e4e5e7;
      }

      .footer {
        margin-top: auto;
      }

      .hidden {
        display: none !important;
      }

      .field {
        margin-bottom: 15px;
      }
      .flex {
        display: flex;
        gap: 10px; 
      }
      .homey-form-input[type="date"] {
        padding: 8px;
        border-radius: 5px;
        border: solid 1px #ccc;
        display: block;
        width: 100%;
        box-sizing: border-box;
        margin: 0 1px;
        line-height: 24px;
      }

      .homey-table {
        width: 100%;
        box-sizing: border-box;
        margin-bottom: 10px;
      }

      .homey-table tr th, .homey-table tr td {
        padding: 5px;
      }

      .homey-table button {
        padding: 5px 10px;
        font-size: 15px;
        margin: 0 3px 5px 0;
      }

      .flex {
        display: flex;
      }

      .flex button:not(:first-child) {
        margin-left: 5px;
      }
      /* Verdeling met 2 velden op een rij */
.flex-2 {
  display: flex;
  gap: 10px; /* Voeg hier de gewenste tussenruimte in pixels toe */
}

/* Beide velden in de rij nemen de helft van de beschikbare ruimte in */
.field-2:nth-child(1),
.field-2:nth-child(2) {
  flex: 1;
}

/* Verdeling met 3 velden op een rij */
.flex-3 {
  display: flex;
  gap: 10px; /* Voeg hier de gewenste tussenruimte in pixels toe */
}

/* Het eerste veld in de rij neemt 1/2 van de beschikbare ruimte in, de andere twee elk 1/4 */
.field-3:nth-child(1) {
  flex: 2;
}

.field-3:nth-child(2),
.field-3:nth-child(3) {
  flex: 1;
}

    </style>
</head>

<body>
<div style="width:100%; text-align:center;">
    <img src="https://raw.githubusercontent.com/LRvdLinden/P2000-brand/main/banners/banner.png"
         alt="Banner" style="max-width:100%;">
</div>

<header class="homey-header">
    <h1 class="homey-title" data-i18n="settings.title"></h1>
    <p class="homey-subtitle" data-i18n="settings.description"></p>
    <button id="add-person-button" class="homey-button-secondary-shadow-full"
        data-i18n="settings.person.add"></button><br>
</header>


<div id="create-or-edit-form" class="form-wrapper hidden">
    <form class="homey-form">
        <fieldset class="homey-form-fieldset">
            <legend class="homey-form-legend" data-i18n="settings.person.title">Person</legend>

            <div class="flex-2">
              <div class="field-2 homey-form-group">
                <label class="homey-form-label" for="name" data-i18n="settings.person.name"></label>
                <input class="homey-form-input" id="name" type="text" />
            </div>

            <div class="field-2 homey-form-group">
              <label class="homey-form-label" for="dateOfBirth" data-i18n="settings.person.dateOfBirth"></label>
              <input class="homey-form-input" id="dateOfBirth" type="date" />
          </div>
        </div>

            <div class="flex-2">
              <div class="field-2 homey-form-group">
                <label class="homey-form-label" for="mobile" data-i18n="settings.person.mobile"></label>
                <input class="homey-form-input" id="mobile" type="text" />
            </div>

            <div class="field-2 homey-form-group">
              <label class="homey-form-label" for="mobile2" data-i18n="settings.person.mobile2"></label>
              <input class="homey-form-input" id="mobile2" type="text" />
          </div>
        </div>

        <div class="homey-form-group">
          <label class="homey-form-label" for="category" data-i18n="settings.person.category"></label>
          <select id="category" class="homey-form-select">
              <option value="Work">Work</option>
              <option value="Private">Private</option>
          </select>
      </div>
          <div class="homey-form-group">
                <label class="homey-form-label" for="message" data-i18n="settings.person.message"></label>
                <textarea class="homey-form-textarea" id="message" rows="3"></textarea>
            </div>

            <div class="flex">
                <button id="save-button" class="homey-button-primary-full"
                        data-i18n="settings.person.save"></button>
                <button id="cancel-button" class="homey-button-secondary-full-shadow"
                        data-i18n="settings.person.cancel"></button>
            </div>
        </fieldset>
    </form>

    <!--    <div class="footer">-->
    <!--        <p id="hint" class="alert hint hidden"></p>-->
    <!--        <p class="alert help">-->
    <!--            <span data-i18n="pair.add_by_ip.need_help_pairing">Need help pairing?</span>-->
    <!--            <a href="https://homey-philips-tv.gitbook.io/homey-philips-tv/guides/pairing"-->
    <!--               data-i18n="pair.add_by_ip.click_here_documentation">Click here to view the documentation.</a>-->
    <!--        </p>-->
    <!--    </div>-->
</div>

<div id="person-list">
    <h2 class="homey-title" data-i18n="settings.personList.title"></h2>

    <table class="homey-table" id="person-table">
        <thead>
        <tr>
            <th data-i18n="settings.personList.name">Name</th>
            <th data-i18n="settings.personList.dateOfBirth">Date of birth</th>
            <th data-i18n="settings.personList.age">Age</th>
            <th data-i18n="settings.personList.message">Message</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>



<!--<div id="verjaardagen">-->

<!--    <h2 data-i18n="settings.personList.title"></h2>-->
<!--    <ul id="birthdayList"></ul>-->

<!--    <button class="homey-button-primary-shadow-full" onclick="save()" data-i18n="settings.saveBtn"></button>-->
<!--</div>-->

<script type="text/javascript">
  let persons = [];
  let myHomey;
  let editingIndex = -1;
  let editingPerson = null;

  function onHomeyReady (Homey) {
    myHomey = Homey;
    myHomey.ready();

    loadPersons();
  }

  function loadPersons () {
    myHomey.get("persons", function(err, data) {
      if (!err && data) {
        persons = data;
        sortBirthdays();
        renderPersons();
      }
    });
  }

  function sortBirthdays() {
  const today = new Date();
  const currentYear = today.getFullYear();
  const currentDayOfYear = getDayOfYear(today);

  persons.sort((a, b) => {
    // CreÃ«er een datum voor dit jaar voor beide verjaardagen
    const dateA = new Date(a.dateOfBirth);
    dateA.setFullYear(currentYear);
    const dayOfYearA = getDayOfYear(dateA);

    const dateB = new Date(b.dateOfBirth);
    dateB.setFullYear(currentYear);
    const dayOfYearB = getDayOfYear(dateB);

    // Bepaal of de verjaardag al geweest is door te kijken of de dag van het jaar groter is dan vandaag
    const isPastA = dayOfYearA < currentDayOfYear;
    const isPastB = dayOfYearB < currentDayOfYear;

    if (isPastA !== isPastB) {
      // Als een van de twee verjaardagen al geweest is, dan sorteren we die naar beneden
      return isPastA ? 1 : -1;
    }

    // Als beide verjaardagen in het verleden of de toekomst zijn, sorteer dan op dag van het jaar
    return dayOfYearA - dayOfYearB;
  });
}

// Helper functie om de dag van het jaar te krijgen
function getDayOfYear(date) {
  const start = new Date(date.getFullYear(), 0, 0);
  const diff = date - start;
  const oneDay = 1000 * 60 * 60 * 24;
  return Math.floor(diff / oneDay);
}


  const tableBodyElement = document.querySelector("#person-table tbody");
  const personsListElement = document.querySelector("div#person-list");
  const createOrEditFormElement = document.querySelector("div#create-or-edit-form");
  const addPersonButtonElement = document.querySelector("#add-person-button");
  const saveButtonElement = document.querySelector("#save-button");
  const cancelButtonElement = document.querySelector("#cancel-button");

  addPersonButtonElement.addEventListener("click", showCreateOrEdit);
  saveButtonElement.addEventListener("click", addOrUpdateBirthday);
  cancelButtonElement.addEventListener("click", cancelCreateOrEdit);

  function renderPersonRow (person, tableBody) {
    console.log("creating row");
    const row = document.createElement("tr");

    const nameCell = document.createElement("td");
    nameCell.textContent = person.name;
    row.appendChild(nameCell);

    const dateOfBirthCell = document.createElement("td");
    const dateParts = person.dateOfBirth.split("-");
    const formattedDate = `${dateParts[2]}-${dateParts[1]}`;
    dateOfBirthCell.textContent = formattedDate;
    row.appendChild(dateOfBirthCell);

    const ageCell = document.createElement("td");
    const ageValue = getPersonAge(person);
    ageCell.textContent = (ageValue === 'N/A') ? ageValue : ageValue + 1;
    row.appendChild(ageCell);



    const messageCell = document.createElement("td");
    messageCell.textContent = person.message;
    row.appendChild(messageCell);

    tableBody.appendChild(row);

    const actionRow = document.createElement("tr");

    const actionsCell = document.createElement("td");

    actionsCell.colSpan = 4;
    actionsCell.style.textAlign = "center";
    actionsCell.style.borderBottom = "solid 1px #eee";

    const editButton = document.createElement("button");
    editButton.classList.add("homey-button-secondary-shadow");
    editButton.textContent = myHomey.__("settings.personList.edit");
    editButton.addEventListener("click", () => editPerson(person));
    actionsCell.appendChild(editButton);

    const deleteButton = document.createElement("button");
    deleteButton.classList.add("homey-button-danger-shadow");
    deleteButton.textContent = myHomey.__("settings.personList.delete");
    deleteButton.addEventListener("click", () => deletePerson(person.id));
    actionsCell.appendChild(deleteButton);

    actionRow.appendChild(actionsCell);

    tableBody.appendChild(actionRow);
  }

  function getPersonAge(person) {
    const today = new Date();
    const birthDate = new Date(person.dateOfBirth);

    // Controleer eerst of de geboortedatum in de toekomst ligt of het huidige jaar is
    if (birthDate > today || birthDate.getFullYear() === today.getFullYear()) {
        return 'N/A';
    }

    let age = today.getFullYear() - birthDate.getFullYear();
    const month = today.getMonth() - birthDate.getMonth();

    // Als we nog voor de verjaardag van dit jaar zitten, trekken we 1 jaar af
    if (month < 0 || (month === 0 && today.getDate() <= birthDate.getDate())) {
        age--;
    }

    // Als het de dag na de verjaardag is, voegen we 1 jaar toe
    if (month === 0 && today.getDate() === birthDate.getDate() + 1) {
        age++;
    }

    return age;
}


const ageCell = document.createElement("td");
const age = getPersonAge(person);
ageCell.textContent = (age === 'N/A') ? age : age + 1; // Behoud je originele logica om 1 toe te voegen, indien nodig
row.appendChild(ageCell);


  // Function to render the list of persons
  function renderPersons () {
    console.log("Rendering persons", { persons });
    console.log(tableBodyElement);
    tableBodyElement.innerHTML = "";
    console.log(tableBodyElement);
    persons.forEach(person => {
      console.log(person);
      renderPersonRow(person, tableBodyElement);
    });
  }

  // Function to edit a person (placeholder function for now)
  function editPerson (person) {
    editingIndex = persons.findIndex(p => p.id === person.id);

    createOrEditFormElement.classList.remove("hidden");
    personsListElement.classList.add("hidden");
    addPersonButtonElement.classList.add("hidden");

    console.log(`Edit person with ID ${person.id}`);

    document.getElementById("name").value = person.name;
    document.getElementById("dateOfBirth").value = person.dateOfBirth;
    document.getElementById("mobile").value = person.mobile;
    document.getElementById("mobile2").value = person.mobile2;
    document.getElementById("message").value = person.message;
    document.getElementById("category").value = person.category;

    editingPerson = person;
  }

  // Function to delete a person (placeholder function for now)
  function deletePerson (personId) {
    console.log(`Delete person with ID ${personId}`);

    persons = persons.filter(person => person.id !== personId);

    save();

    renderPersons();
  }

  function showCreateOrEdit (event) {
    clearFields();

    event?.preventDefault();
    addPersonButtonElement.classList.add("hidden");
    personsListElement.classList.add("hidden");
    createOrEditFormElement.classList.remove("hidden");
  }

  function cancelCreateOrEdit (event) {
    event?.preventDefault();
    personsListElement.classList.remove("hidden");
    addPersonButtonElement.classList.remove("hidden");
    createOrEditFormElement.classList.add("hidden");
  }

  function isValid (person) {
    const nowDate = new Date();
    const dateOfBirthDate = new Date(person.dateOfBirth);

    return dateOfBirthDate.getFullYear() >= 1900
      && dateOfBirthDate.getFullYear() <= nowDate.getFullYear()
      && person.name !== ""
      && person.name !== undefined
      && person.dateOfBirth !== ""
      && person.dateOfBirth !== undefined;
  }

  function addOrUpdateBirthday (event) {
    event?.preventDefault();

    const person = {
      id: guid(),
      name: document.getElementById("name").value,
      dateOfBirth: document.getElementById("dateOfBirth").value,
      mobile: document.getElementById("mobile").value ?? null,
      mobile2: document.getElementById("mobile2").value ?? null,
      message: document.getElementById("message").value ?? null,
      category: document.getElementById("category").value ?? null
    };

    if (!isValid(person)) {
      myHomey.alert(myHomey.__("messages.validation_error"));
    } else {
      if (editingIndex === -1) {
        persons.push(person);
      } else {
        persons[editingIndex] = person;
        editingIndex = -1;
      }

      save();
      renderPersons();
      cancelCreateOrEdit(event);
    }
  }

  function fillCreateOrEditForm ({ name, dateOfBirth, mobile, mobile2, message, category }) {
    document.getElementById("name").value = name ?? "";
    document.getElementById("dateOfBirth").value = dateOfBirth ?? "";
    document.getElementById("mobile").value = mobile ?? "";
    document.getElementById("mobile2").value = mobile2 ?? "";
    document.getElementById("message").value = message ?? "";
    document.getElementById("category").value = category ?? "";
  }

  function editBirthday (index) {
    const selectedPerson = persons[index];

    fillCreateOrEditForm(selectedPerson);

    editingIndex = index;
  }

  function clearFields () {
    fillCreateOrEditForm({});

    editingIndex = -1;
  }

  function guid () {
    function s4 () {
      return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
    }

    return s4() + s4() + "-" + s4() + "-" + s4() + "-" + s4() + "-" + s4() + s4() + s4();
  }

  function save () {
    sortBirthdays();
    myHomey.set("persons", persons, function(error) {
      if (error) {
        console.error(error);
        myHomey.alert("Error saving data!");
        return;
      }
      clearFields();
    });
  }

  document.addEventListener("DOMContentLoaded", function() {
    // initializeTranslations();
  });

</script>
</body>

</html>
