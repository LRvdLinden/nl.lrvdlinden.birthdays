<!DOCTYPE html>
<html>

<head>
    <script type="text/javascript" src="/homey.js" data-origin="settings"></script>
    <style>
      .field {
        margin-bottom: 15px;
      }
    </style>
</head>

<body>
<div style="width:100%; text-align:center;">
    <img src="https://raw.githubusercontent.com/LRvdLinden/P2000-brand/main/banners/settings_banner_birthdays.jpg"
         alt="Banner" style="max-width:100%;">
</div>

<div id="verjaardagen">
    <h1 data-i18n="settings.title"></h1>
    <p data-i18n="settings.description"></p>

    <div class="field">
        <label for="name" data-i18n="settings.name"></label>
        <input id="name" type="text" />
    </div>

    <div class="field">
        <label for="mobile" data-i18n="settings.mobile"></label>
        <input id="mobile" type="text" />
    </div>

    <div class="field">
        <label for="message" data-i18n="settings.message"></label>
        <input id="message" type="text" />
    </div>

    <div class="field">
        <label for="year" data-i18n="settings.year"></label>
        <input id="year" type="number" />
    </div>

    <div class="field">
        <label for="dateOfBirth" data-i18n="settings.dateOfBirth"></label>
        <input id="dateOfBirth" type="date" />
    </div>

    <div class="field">
      <label for="category" data-i18n="settings.category">Category</label>
      <select id="category">
          <option value="Work">Work</option>
          <option value="Private">Private</option>
      </select>
  </div>
  
    <button onclick="addOrUpdateBirthday()" data-i18n="settings.addBtn"></button>

    <h2 data-i18n="settings.listTitle"></h2>
    <ul id="birthdayList"></ul>

    <button class="homey-button-primary-full" onclick="save()" data-i18n="settings.saveBtn"></button>
</div>

<script type="text/javascript">
  // Zorg ervoor dat je een manier hebt om de vertalingen vanuit de externe nl.json (en andere taalbestanden) te laden en toe te passen.
  function initializeTranslations () {
  }

  let birthdays = [];
  let myHomey;
  let editingIndex = -1;

  function onHomeyReady (Homey) {
    myHomey = Homey;
    myHomey.ready();
    loadBirthdays();
  }

  function loadBirthdays () {
    myHomey.get("persons", function(err, data) {
      if (!err && data) {
        birthdays = data;
        displayBirthdays();
      }
    });
  }

  function sortBirthdays () {
    birthdays.sort((a, b) => {
      const dateA = new Date(a.dateOfBirth);
      const dateB = new Date(b.dateOfBirth);
      return dateA - dateB;
    });
  }

  function displayBirthdays () {
    sortBirthdays();

    const list = document.getElementById("birthdayList");
    list.innerHTML = "";

    birthdays.forEach((birthday, index) => {
      const listItem = document.createElement("li");
      const text = document.createTextNode(`${birthday.name} - ${birthday.dateOfBirth} - ${birthday.year} - ${birthday.mobile} - ${birthday.message} - ${birthday.category}`);
      listItem.appendChild(text);

      const deleteButton = document.createElement("button");
      deleteButton.innerText = "Delete";
      deleteButton.onclick = function() {
        removeBirthday(index);
      };
      listItem.appendChild(deleteButton);

      const editButton = document.createElement("button");
      editButton.innerText = "Edit";
      editButton.onclick = function() {
        editBirthday(index);
      };
      listItem.appendChild(editButton);

      list.appendChild(listItem);
    });
  }

  function addOrUpdateBirthday () {
    const name = document.getElementById("name").value;
    const dateOfBirth = document.getElementById("dateOfBirth").value;
    const mobile = document.getElementById("mobile").value;
    const message = document.getElementById("message").value;
    const year = document.getElementById("year").value;
    const currentYear = new Date().getFullYear();
    const category = document.getElementById("category").value;

    // Year validation
    if (year && year !== "" && (isNaN(year) || year < 1900 || year > currentYear)) {
      alert("Voer een geldig geboortejaar in tussen 1900 en " + currentYear);
      return;
    }

    // Mandatory field validation
    if (name && dateOfBirth) {
      const birthdayObject = {
        name,
        dateOfBirth,
        mobile: mobile || null,
        message: message || null,
        year: year || null,
        category
      };

      if (editingIndex === -1) {
        birthdays.push(birthdayObject);
      } else {
        birthdays[editingIndex] = birthdayObject;
        editingIndex = -1;
      }

      displayBirthdays();
      clearFields(); // Voeg dit toe aan het einde van de functie
    } else {
      alert("Please fill in mandatory fields.");
    }
  }

  function editBirthday (index) {
    const selectedBirthday = birthdays[index];
    document.getElementById("name").value = selectedBirthday.name;
    document.getElementById("dateOfBirth").value = selectedBirthday.dateOfBirth;
    document.getElementById("mobile").value = selectedBirthday.mobile;
    document.getElementById("message").value = selectedBirthday.message;
    document.getElementById("year").value = selectedBirthday.year;
    document.getElementById("category").value = selectedBirthday.category;

    editingIndex = index;
  }

  function removeBirthday (index) {
    birthdays.splice(index, 1);
    displayBirthdays();
  }

  function clearFields () {
    document.getElementById("name").value = "";
    document.getElementById("dateOfBirth").value = "";
    document.getElementById("mobile").value = "";
    document.getElementById("message").value = "";
    document.getElementById("year").value = "";
    document.getElementById("category").value = "";

    editingIndex = -1;
  }

  function save () {
    myHomey.set("persons", birthdays, function(error) {
      if (error) {
        alert("Error saving data!");
        return;
      }
      clearFields();
    });
  }

  document.addEventListener("DOMContentLoaded", function() {
    initializeTranslations();
  });

</script>
</body>

</html>
